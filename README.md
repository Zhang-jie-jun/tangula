# Tangula
唐古拉山脉，长江正源，滋润万物。
Tangula 寓意数据的源头，为研发团队提供即取即用的数据服务，帮助团队高效产出。


##
## 项目架构
> 该项目是gin+vue实现的前后端分离项目，使用gorm访问MySQL。  
> 使用LDAP服务对用户进行权限认证。  
> 使用gin-jwt组件，对API接口进行权限控制。  
> 在token过期后的半个小时内，用户再次操作会自动刷新token。  


##
## 代码运行方式
### go后台服务运行方式
>1.在MySQL中运行文件夹/conf/sql中的mysql.sql脚本  
>2.在文件夹/conf/api.ini中修改数据库连接配置  
>3.在Tangula主目录下运行`go run main.go`

### vue运行方式请看文件夹/vue-admin中的README.md


##
## 项目简介
### 概念
+ 平台资源：指的是虚拟化或云平台。  
+ 主机资源：指的是系统层面的物理主机(包含虚拟机)。  
+ 存储池：基于ceph存储管理的存储池，对应ceph存储的镜像存储池。  
+ 数据镜像：基于ceph存储管理的镜像，可读不可写。  
+ 数据副本：基于ceph存储管理的镜像，可读可写。  
+ 副本快照：基于ceph存储管理的镜像快照。  

### 功能
1. 支持用户登录鉴权（区分admin与user，admin支持启用、禁用用户及更改用户角色）。  
2. 支持ceph存储镜像管理（副本镜像管理）。  
3. 支持主机、虚拟化及云平台管理（添加、编辑、删除），用于配置副本挂载规则。  
4. 支持配置副本规则（管理副本生命周期，固化挂载配置）。  
5. 支持资源发布管理（资源共享）。  
6. 支持平台操作日志记录。  
7. 支持资源搜索。  
8. 支持在线API文档浏览。  

### 场景
![场景](https://github.com/Zhang-jie-jun/tangula/main/static/backdrop.png)
####场景说明：
1. 资源发布中心：所有用户可见，用户可发布数据镜像或虚拟化(云)平台等资源到资源发布中心。
2. 平台资源：当前用户可见，管理当前用户创建的虚拟化(云)平台资源。
3. 存储池：当前用户可见，管理当前用户创建的存储池，数据镜像，数据副本或副本快照等资源。
4. 数据镜像：可读不可写，不支持快照，不可直接创建，可由数据副本转换而成。支持发布，克隆生成数据副本，删除操作。
5. 数据副本：可读可写，支持创建、删除、快照、复制副本、转换成镜像，挂载，取消挂载操作。
6. 副本快照：可读不可写，支持创建、删除、回滚、克隆新数据副本。

### 部署
#### 构建
1. 确认go.mod中go-ceph的版本为v0.6.0（重要）
2. go mod tidy 
3. go build -tags luminous
4. 环境变量参考： Golang go mod 环境变量配置
5. ceph客户端：
   1. 安装 yum install ceph -y
   2. 服务端拷贝 /etc/ceph/ceph.client.admin.keyring 和/etc/ceph/ceph/conf 到客户端（相同目录）
   3. 可能需要先安装gcc：yum install -y gcc
   4. 可能需要安装依赖库：yum install libcephfs-devel librados-devel librbd-devel  
   
#### 后端部署
1. 构建环境必须是Linux系统，且已安装ceph客户端，连接到ceph服务端。
2. git pull拉取代码。构建步骤同上。
3. 将构建出的可执行文件传到tangula服务端(scp -r tangula root@127.0.0.1:/tangula
4. 在tangula服务端重启服务：supervisorctl restart tangula

#### 前端部署
1. 开发环境本地构建: npm run build  
2. 打包 tar -czvf xxxxxxxxxxxxx.tar.gz dist/
3. 将tar包上传到唐古拉服务端的/tangula/web目录
4. 执行脚本./build.sh xxxxxxxxxxxxx.tar.gz

##
## 用户指南
### 授权管理
#### 认证方式
Tangula平台支持接入AD域，使用LDAP协议进行统一认证，使用域账户登录。如：testUser@test.com test_pswd123。

#### 权限划分
Tangula平台设置普通用户与系统管理员两个权限组。  
+ 系统管理员支持管理平台上所有的用户权限、公共资源及自身的私有资源。  
+ 普通用户仅支持管理自身的私有资源，可以浏览公共资源。  
+ 普通用户可以找管理员将自己也设置为管理员。  

### 资源管理
#### 平台管理
+ 平台管理核心功能是对虚拟化平台与云平台的统一管理。
+ 页面划分两个大项，公共平台与私有平台。
+ 公共平台页面：普通用户仅支持浏览平台信息，系统管理员支持删除平台。
+ 私有平台页面：所有用户支持创建、编辑、删除、发布及浏览平台功能，用户之间资源互相隔离，仅当前用户可见。
+ 私有平台发布后展示到公共平台页面，所有用户可见，发布后的资源不在属于用户自身，由系统管理员管理。
![平台](https://github.com/Zhang-jie-jun/tangula/main/static/platform.png)

#### 主机管理
+ 主机管理核心功能是对Linux或Windows主机的统一管理。  
+ 页面划分两个大项，公共平台与私有平台。  
+ 公共主机页面：普通用户仅支持浏览主机信息，系统管理员支持删除主机。  
+ 私有主机页面：所有用户支持创建、编辑、删除、发布及浏览主机功能，用户之间资源互相隔离，仅当前用户可见。  
+ 私有主机发布后展示到公共主机页面，所有用户可见，发布后的资源不在属于用户自身，由系统管理员管理。  
```
前置条件：鉴于添加平台的过程中需要对远程主机进行认证操作，请确保需要添加的目标主机系统已经安装并启动ssh服务与nfs客户端服务
```
![主机](https://github.com/Zhang-jie-jun/tangula/main/static/host.png)

#### 存储池管理
+ 存储池管理的核心功能是管理ceph存储池。  
+ 普通用户仅支持浏览存储池，系统管理员可以创建、删除存储池。  
```
存储池是副本与镜像的载体
```
![存储池](https://github.com/Zhang-jie-jun/tangula/main/static/storage.png)

### 数据管理
#### 副本管理
副本是一个可读可写、支持快照、支持挂载的数据存储，类似于磁盘设备。  
副本有多种类型，目前有VMware VM、CAS VM 、Custom等。  
+ VMware VM副本可以存储一个VMware虚拟机，只支持挂载到VMware平台，挂载时支持注册虚拟机，开启虚拟机电源，配置虚拟机系统主机名及IP信息。  
+ CAS VM副本可以存储多个CAS虚拟机文件及配置文件，只支持挂载到CAS平台，挂载后可以根据配置文件生成若干台虚拟机。  
+ Custom副本可以存储任意数据，支持挂载到主机。挂载时支持仅导出路径、默认挂载及脚本挂载。
```
默认挂载是指挂载到目标主机一个默认的目录上，脚本挂载是指用户可以自定义脚本，完成共享路径导出后执行用户上传的脚本。
```
![副本](https://github.com/Zhang-jie-jun/tangula/main/static/replica.png)

#### 镜像管理 
镜像是一个只读的特殊副本，不支持快照及挂载功能，不支持直接创建镜像，可以根据场景选择从副本或快照生成镜像，支持从镜像生成副本。    
+ 公共镜像页面：普通用户仅支持查看镜像信息与基于该镜像生成副本，系统管理员支持删除公共镜像。  
+ 私有镜像页面：所有用户支持删除、发布及查看镜像功能，用户之间资源互相隔离，仅当前用户可见。  
```
私有镜像发布后展示到公共镜像页面，所有用户可见，发布后的资源不在属于用户自身，由系统管理员管理。
```
![镜像](https://github.com/Zhang-jie-jun/tangula/main/static/image.png)
    
### 用户管理
用户管理需要系统管理员权限，普通用户无法浏览该页面。  

#### 用户管理
根据以下操作进入用户管理页面：  
+ 第1步：系统管理员登录Tangula平台。  
+ 第2步：点击左侧导航栏【用户管理】→【用户列表】，进入 “用户管理” 界面。  
```
在该页面系统管理员可以对平台上所有用户进行权限设置。
系统管理员可以禁用或启用普通用户，不支持禁用系统管理员。
系统管理员可以编辑用户角色，将普通用户升级为系统管理员，或将系统管理员降级为普通用户，系统管理员支持更改自身或其他系统管理员权限。
```
![用户](https://github.com/Zhang-jie-jun/tangula/main/static/user.png)

#### 角色管理
根据以下操作进入角色管理页面：  
+ 第1步：系统管理员登录Tangula平台。  
+ 第2步：点击左侧导航栏【用户管理】→【角色列表】，进入 “角色管理” 界面。  
```
当前Tangula平台仅支持普通用户与系统管理员两种角色，后续将会扩展更多自定义角色类型。
```

#### 操作记录
根据以下操作进入操作记录页面：  
+ 第1步：系统管理员登录Tangula平台。  
+ 第2步：点击左侧导航栏【用户管理】→【操作记录】，进入 “操作记录” 界面。  
```
操作记录界面记录了Tangula平台上所有用户的操作记录
```
![记录](https://github.com/Zhang-jie-jun/tangula/main/static/record.png)